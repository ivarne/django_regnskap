{% extends "base.html" %}
{% block title %}Konto {{konto}}{% endblock %}

{% block content %}
<h1>{{konto}}</h1>
<p>{{konto.beskrivelse}}</p>
<a href="{{konto.get_admin_url}}">Rediger</a>
<div id="konto_graph_slide">
  {% for year in years %}
    <img {% if forloop.first %}class="active"{% endif %} year ="{{year}}" src="https://regnskap.laget.net/regnskap/show/konto_graph/{{year}}-{{konto.id}}.png">
  {% endfor %}
</div>
<h2>Sisste bilag</h2>
<table>
  <tr>
    <th colspan="3">Dato</th>
    <th>Bilag #</th>
    <th>Beskrivelse</th>
    <th>Debet</th>
    <th>Kredit</th>
    <th>Mot konto</th>
    <th>Ekstern</th>
  </tr>
{% for innslag in innslags %}
  <tr>
    <td>
      {% ifchanged innslag.bilag.dato|date:"Y" %}
      <b>{{innslag.bilag.dato|date:"Y"}}</b>
      {% endifchanged %}
    </td>
    <td>
      {% ifchanged innslag.bilag.dato|date:"b" %}
      {{innslag.bilag.dato|date:"b"}}
      {% endifchanged %}
    </td>
    <td class='tableNumber'>{{innslag.bilag.dato|date:"j"}}</td>
    <td class="tableNumber">
      <a href="{{innslag.bilag.get_absolute_url}}">
      {{innslag.bilag.getNummer}}
      </a>
    </td>
    <td>{{innslag.bilag.beskrivelse}}</td>
    <td class="tableNumber">{{innslag.debit|default_if_none:"&nbsp;"}}</td>
    <td class="tableNumber">{{innslag.kredit|default_if_none:"&nbsp;"}}</td>
    <td>
      {% if innslag.bilag.related_kontos|length < 4 %}
        {% for konto in innslag.bilag.related_kontos %}
          {% if konto != innslag.konto %}
            <a title="{{konto.prosjekt}}/{{konto.tittel}}&#10;{{konto.beskrivelse}}" href="{{konto.get_absolute_url}}">{{konto.nummer}}</a>
          {% endif %}
        {% endfor %}
      {% else %}
      <a href="{{innslag.bilag.get_absolute_url}}" title="Det er for mange kontoer til at det ikke øndelegger tabellen å vise alle">...</a>
      {% endif %}
    </td>
    <td><a href="{{innslag.bilag.external_actor.get_absolute_url}}">{{innslag.bilag.external_actor}}</a></td>
  </tr>
{% endfor %}
</table>

<script>
$(document).ready(function(){
  // cheat so that the function uses this like a jquery module would do
  // sometime it might be moved to a separate jquery module if need might rise
  $("#konto_graph_slide").each(function(){
    var years = {};
    var years_list = [];
    // remove $() on this if changed into jquery plugin
    var prev_active = $(this).children("img.active");
    var img = $(this).children("img");
  
    img.each(function(){
      var year = this.attributes['year'].value
      years[year] = $(this);
      years_list.push(year);
    });
    img.click(function(){
      prev_active.removeClass('active');
      //rotate years_list
      years_list.push(years_list.shift());

      prev_active = years[years_list[0]];
      prev_active.addClass('active');
    });
  });
});
</script>
{% endblock %}
