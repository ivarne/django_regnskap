{% extends "base.html" %}
{% block title %}Registrering av bilag fra kontoutskrift{% endblock %}

{% block content %}
<textarea id="csv_inn" style="width:100%;height:50%" placeholder="Lim inn CSV innput her">
</textarea>
<form method="POST" action="">
<table>
{{metadata_form}}
</table>

<input type="submit">

{%csrf_token%}
{{row_formset.management_form}}
<table>
    <thead>
        <tr>
            <th>Aktiv</th>
            <th>Date</th>
            <th>Text</th>
            <th>Bel√∏p</th>
        </tr>
    </thead>
    <tbody id="table_body_bilag">
    {% for row in row_formset %}
        <tr>
            <td>{{row.DELETE.errors}}{{row.DELETE}}</td>
            <td>{{row.date.errors}}{{row.date}}</td>
            <td>{{row.text.errors}}{{row.text}}</td>
            <td>{{row.ammount.errors}}{{row.ammount}}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</form>

<script>
function update_form(){
    var date_regex = /^([0123]\d)\.([01]\d)\.(2[012]\d\d)$/g
    var TOTAL_FORMS = parseInt($("#id_rows-TOTAL_FORMS").val(),10);
    var rows = $("#csv_inn").val().split("\n");
    var i = 0;
    while(i < rows.length){
        $("#id_rows-"+i+"-date").parent().parent()[0].hidden = false;
        var row = rows[i].split("\t");
        var text = "";
        var date = "";
        var DELETE = true;
        var ammount = "";
        if(row.length == 7){
            if(date_regex.test(row[0])){
                DELETE = false;
                date = row[0].replace(date_regex,"$3-$2-$1");
            }else{
                date = row[0];
            }
            text = row[2]+ " " + row[3] + " " + row[6];
            ammount = row[4].replace(",",".");
        }
        $("#id_rows-"+i+"-date").val(date);
        $("#id_rows-"+i+"-text").val(text);
        $("#id_rows-"+i+"-DELETE").prop("checked", DELETE);
        $("#id_rows-"+i+"-ammount").val(ammount);
        i++;
    }
    // Ensure that the rest of the forms are inactive, empty and hidden
    while(i<TOTAL_FORMS){
        $("#id_rows-"+i+"-date").parent().parent()[0].hidden = true;
        $("#id_rows-"+i+"-DELETE").prop("checked", true);
        $("#id_rows-"+i+"-date").val("");
        $("#id_rows-"+i+"-text").val("");
        $("#id_rows-"+i+"-ammount").val("");
        i++;
    }
    
}
$("#csv_inn").change(update_form);
$(update_form);
</script>
{% endblock %}